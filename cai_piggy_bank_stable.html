<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cai çš„å°é‡‘åº“</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- å¼•å…¥ Babel ç”¨äºåœ¨æµè§ˆå™¨ä¸­ç¼–è¯‘ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* é˜»æ­¢ iPad ä¸Šä¸‹æ‹–æ‹½æ—¶çš„å›å¼¹æ•ˆæœï¼Œæ¶ˆé™¤ç‚¹å‡»é«˜äº®ï¼Œè®©å®ƒæ›´åƒåŸç”Ÿ App */
        body { 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- é©¬è’‚æ–¯è°ƒè‰²æ¿ä¸å½¢çŠ¶ ---
        const COLORS = {
          blue: '#002eb8',
          pink: '#e60073',
          yellow: '#ffd633',
          green: '#00b359',
          orange: '#ff5c33',
          bg: '#fdfbf7',
          text: '#1a1a1a'
        };

        const getRandomBlobShape = () => {
          const r = () => Math.floor(Math.random() * 40 + 40); 
          return `${r()}% ${r()}% ${r()}% ${r()}% / ${r()}% ${r()}% ${r()}% ${r()}%`;
        };

        // --- å‰ªçº¸æ˜Ÿç©ºç»„ä»¶ (Canvas) ---
        const MatisseUniverse = ({ balance }) => {
          const canvasRef = useRef(null);
          const planetsRef = useRef([]);

          useEffect(() => {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            let animationFrameId;

            const resize = () => {
              canvas.width = canvas.parentElement.clientWidth;
              canvas.height = canvas.parentElement.clientHeight;
            };
            window.addEventListener('resize', resize);
            resize();

            const createCutoutPlanet = (x, y, radius, color) => {
              ctx.beginPath();
              const points = 8;
              for (let i = 0; i < points; i++) {
                const angle = (i / points) * Math.PI * 2;
                const rOffset = radius * (0.8 + Math.random() * 0.4); 
                const px = x + Math.cos(angle) * rOffset;
                const py = y + Math.sin(angle) * rOffset;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
              }
              ctx.closePath();
              ctx.fillStyle = color;
              ctx.fill();
            };

            const targetPlanetCount = Math.max(0, Math.floor(balance / 10));
            
            if (planetsRef.current.length < targetPlanetCount) {
              const colors = [COLORS.pink, COLORS.blue, COLORS.green, COLORS.orange, COLORS.yellow];
              while (planetsRef.current.length < targetPlanetCount) {
                planetsRef.current.push({
                  distance: 60 + planetsRef.current.length * 25,
                  angle: Math.random() * Math.PI * 2,
                  speed: 0.001 + Math.random() * 0.002, 
                  radius: 8 + Math.random() * 6,
                  color: colors[planetsRef.current.length % colors.length]
                });
              }
            } else if (planetsRef.current.length > targetPlanetCount) {
              planetsRef.current = planetsRef.current.slice(0, targetPlanetCount);
            }

            const render = () => {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              const centerX = canvas.width / 2;
              const centerY = canvas.height / 2;

              createCutoutPlanet(centerX, centerY, 35, COLORS.yellow);

              planetsRef.current.forEach(p => {
                p.angle += p.speed;
                const x = centerX + Math.cos(p.angle) * p.distance;
                const y = centerY + Math.sin(p.angle) * p.distance;
                createCutoutPlanet(x, y, p.radius, p.color);
              });

              animationFrameId = requestAnimationFrame(render);
            };
            render();

            return () => {
              window.removeEventListener('resize', resize);
              cancelAnimationFrame(animationFrameId);
            };
          }, [balance]);

          return (
            <div className="relative w-full h-48 sm:h-64 overflow-hidden rounded-b-3xl" style={{ backgroundColor: '#1a1a1a' }}>
              <div className="absolute top-4 left-4 text-white text-sm opacity-80 z-10 font-bold tracking-wider" style={{ fontFamily: 'sans-serif' }}>
                æ¯ 10 å…ƒ = 1 é¢—å‰ªçº¸æ˜Ÿçƒ
              </div>
              <canvas ref={canvasRef} className="w-full h-full block" />
            </div>
          );
        };

        // --- ä¸»åº”ç”¨ ---
        const App = () => {
          const [balance, setBalance] = useState(() => Number(localStorage.getItem('cai_balance')) || 0);
          const [records, setRecords] = useState(() => JSON.parse(localStorage.getItem('cai_records')) || []);
          const [wishlist, setWishlist] = useState(() => JSON.parse(localStorage.getItem('cai_wishlist')) || [
            { id: 1, name: 'å½©è‰²ç”»ç¬”', amount: 25 },
            { id: 2, name: 'å¤§æ¯›ç»’ç†Š', amount: 80 }
          ]);

          const [modal, setModal] = useState({ isOpen: false, type: 'income' });
          const [draftAmount, setDraftAmount] = useState('');
          const [draftText, setDraftText] = useState('');
          const [isHistoryOpen, setIsHistoryOpen] = useState(false);
          const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, recordId: null });
          const [draftDate, setDraftDate] = useState(() => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          });
          
          const [newWishName, setNewWishName] = useState('');
          const [newWishAmount, setNewWishAmount] = useState('');

          useEffect(() => {
            localStorage.setItem('cai_balance', balance.toString());
            localStorage.setItem('cai_records', JSON.stringify(records));
            localStorage.setItem('cai_wishlist', JSON.stringify(wishlist));
          }, [balance, records, wishlist]);

          const confirmDelete = (id) => {
            setDeleteConfirm({ isOpen: true, recordId: id });
          };

          const executeDelete = () => {
            const id = deleteConfirm.recordId;
            const recordToDelete = records.find(r => r.id === id);
            if (recordToDelete) {
              setBalance(prev => prev - recordToDelete.amount);
              setRecords(records.filter(r => r.id !== id));
            }
            setDeleteConfirm({ isOpen: false, recordId: null });
          };

          const handleSaveRecord = () => {
            const amount = parseFloat(draftAmount);
            if (isNaN(amount) || amount <= 0) {
              alert("è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢æ•°å­—å“¦ï¼");
              return;
            }
            if (!draftText) {
              alert("è¯·å†™ä¸‹åŸå› å“¦ï¼");
              return;
            }
            if (modal.type === 'expense' && balance - amount < 0) {
              alert("å“å‘€ï¼Œå°é‡‘åº“çš„é’±ä¸å¤Ÿå•¦ï¼");
              return;
            }

            const actualAmount = modal.type === 'income' ? amount : -amount;
            const [y, m, d] = draftDate.split('-');
            const dateStr = `${parseInt(m)}æœˆ${parseInt(d)}æ—¥`;

            setBalance(prev => prev + actualAmount);
            setRecords([{
              id: Date.now(),
              type: modal.type,
              amount: actualAmount,
              text: draftText,
              date: dateStr
            }, ...records]);

            closeModal();
          };

          const closeModal = () => {
            setModal({ isOpen: false, type: 'income' });
            setDraftAmount('');
            setDraftText('');
            const d = new Date();
            setDraftDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
          };

          const handleAddWish = () => {
            const amount = parseFloat(newWishAmount);
            if (!newWishName || isNaN(amount) || amount <= 0) return;
            setWishlist([...wishlist, { id: Date.now(), name: newWishName, amount }]);
            setNewWishName('');
            setNewWishAmount('');
          };

          const moveWish = (index, direction) => {
            const newList = [...wishlist];
            if (direction === 'up' && index > 0) {
              [newList[index - 1], newList[index]] = [newList[index], newList[index - 1]];
            } else if (direction === 'down' && index < newList.length - 1) {
              [newList[index + 1], newList[index]] = [newList[index], newList[index + 1]];
            }
            setWishlist(newList);
          };

          const removeWish = (id) => {
            setWishlist(wishlist.filter(w => w.id !== id));
          };

          const primaryWish = wishlist[0];

          return (
            <div className="min-h-screen pb-10" style={{ backgroundColor: COLORS.bg, fontFamily: '"Comic Sans MS", "PingFang SC", sans-serif' }}>
              
              <MatisseUniverse balance={balance} />

              <div className="max-w-md mx-auto px-4 -mt-6 relative z-10">
                
                <div className="bg-white p-6 mb-6 shadow-xl flex flex-col items-center justify-center border-4"
                     style={{ borderColor: COLORS.text, borderRadius: '40% 60% 70% 30% / 40% 50% 60% 50%' }}>
                  <p className="text-gray-500 font-bold mb-1">æˆ‘çš„å°é‡‘åº“</p>
                  <h1 className="text-5xl font-black" style={{ color: COLORS.pink }}>Â¥ {balance}</h1>
                </div>

                <div className="flex gap-4 mb-8">
                  <button 
                    onClick={() => setModal({ isOpen: true, type: 'income' })}
                    className="flex-1 py-4 text-white text-xl font-bold shadow-lg transform transition active:scale-95 border-4 border-black"
                    style={{ backgroundColor: COLORS.green, borderRadius: '60% 40% 30% 70% / 50% 60% 40% 50%' }}>
                    â• è¿›è´¦å•¦
                  </button>
                  <button 
                    onClick={() => setModal({ isOpen: true, type: 'expense' })}
                    className="flex-1 py-4 text-white text-xl font-bold shadow-lg transform transition active:scale-95 border-4 border-black"
                    style={{ backgroundColor: COLORS.orange, borderRadius: '30% 70% 60% 40% / 50% 40% 60% 50%' }}>
                    â– èŠ±é’±å•¦
                  </button>
                </div>

                <div className="mb-8 bg-white p-5 rounded-3xl border-4 shadow-md" style={{ borderColor: COLORS.yellow }}>
                  <h2 className="text-xl font-bold mb-4 flex items-center gap-2" style={{ color: COLORS.blue }}>
                    ğŸ¯ æˆ‘çš„å¿ƒæ„¿å•
                  </h2>
                  
                  {primaryWish && (
                    <div className="mb-6 p-4 rounded-2xl bg-opacity-20" style={{ backgroundColor: COLORS.yellow }}>
                      <div className="flex justify-between font-bold mb-2">
                        <span>1. {primaryWish.name}</span>
                        <span>Â¥{primaryWish.amount}</span>
                      </div>
                      <div className="h-4 bg-white rounded-full overflow-hidden border-2 border-black">
                        <div 
                          className="h-full transition-all duration-500"
                          style={{ 
                            backgroundColor: COLORS.pink, 
                            width: `${Math.min(100, (balance / primaryWish.amount) * 100)}%` 
                          }}
                        />
                      </div>
                      <p className="text-right text-sm mt-1 font-bold" style={{ color: COLORS.text }}>
                        {balance >= primaryWish.amount ? 'ğŸ‰ é’±å¤Ÿå•¦ï¼å¯ä»¥ä¹°å•¦ï¼' : `è¿˜å·® Â¥${primaryWish.amount - balance}`}
                      </p>
                    </div>
                  )}

                  <div className="space-y-2 mb-4">
                    {wishlist.map((wish, index) => (
                      <div key={wish.id} className="flex items-center justify-between bg-gray-50 p-2 rounded-xl border-2 border-transparent hover:border-gray-200">
                        <div className="flex items-center gap-2">
                          <span className="font-bold text-gray-400 w-4">{index + 1}.</span>
                          <span className="font-bold truncate max-w-[120px]">{wish.name}</span>
                          <span className="text-sm text-gray-500">Â¥{wish.amount}</span>
                        </div>
                        <div className="flex gap-1">
                          <button onClick={() => moveWish(index, 'up')} disabled={index === 0} className="p-1 disabled:opacity-30">â¬†ï¸</button>
                          <button onClick={() => moveWish(index, 'down')} disabled={index === wishlist.length - 1} className="p-1 disabled:opacity-30">â¬‡ï¸</button>
                          <button onClick={() => removeWish(wish.id)} className="p-1 text-red-500">âœ–ï¸</button>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="flex gap-2">
                    <input 
                      type="text" 
                      placeholder="æƒ³ä¹°ä»€ä¹ˆï¼Ÿ" 
                      value={newWishName}
                      onChange={e => setNewWishName(e.target.value)}
                      className="flex-1 p-2 border-2 border-black rounded-xl text-sm"
                    />
                    <input 
                      type="number" 
                      placeholder="å¤šå°‘é’±ï¼Ÿ" 
                      value={newWishAmount}
                      onChange={e => setNewWishAmount(e.target.value)}
                      className="w-24 p-2 border-2 border-black rounded-xl text-sm"
                    />
                    <button 
                      onClick={handleAddWish}
                      className="px-3 py-2 text-white font-bold border-2 border-black rounded-xl"
                      style={{ backgroundColor: COLORS.blue }}>
                      æ·»åŠ 
                    </button>
                  </div>
                </div>

                <div>
                  <h2 className="text-xl font-bold mb-4 flex items-center gap-2" style={{ color: COLORS.text }}>
                    ğŸ“ è¿‘æœŸè´¦å•è®°å½•
                  </h2>
                  <div className="space-y-3">
                    {records.length === 0 && <p className="text-gray-400 text-center py-4">è¿˜æ²¡æœ‰è®°å½•å“¦ï¼Œå¿«å»è®°ç¬¬ä¸€ç¬”å§ï¼</p>}
                    {records.slice(0, 5).map(rec => (
                      <div key={rec.id} className="bg-white p-4 flex items-center justify-between border-2 shadow-sm"
                           style={{ borderColor: rec.amount > 0 ? COLORS.green : COLORS.orange, borderRadius: getRandomBlobShape() }}>
                        <div className="flex items-center gap-3 overflow-hidden">
                          <div>
                            <div className="font-bold text-lg truncate max-w-[150px]">{rec.text}</div>
                            <div className="text-gray-500 font-bold text-sm">{rec.date}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <div className="font-black text-2xl flex-shrink-0" style={{ color: rec.amount > 0 ? COLORS.green : COLORS.orange }}>
                            {rec.amount > 0 ? '+' : ''}{rec.amount}
                          </div>
                          <button onClick={() => confirmDelete(rec.id)} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-sm active:scale-90 transition hover:bg-red-100" style={{ color: COLORS.orange }}>
                            âœ–ï¸
                          </button>
                        </div>
                      </div>
                    ))}
                    {records.length > 5 && (
                      <button 
                        onClick={() => setIsHistoryOpen(true)}
                        className="w-full py-3 mt-4 text-center font-bold text-gray-600 bg-gray-100 rounded-xl border-2 border-gray-200 hover:bg-gray-200 active:scale-95 transition"
                      >
                        ğŸ“‚ æŸ¥çœ‹å…¨éƒ¨å†å²è´¦å•
                      </button>
                    )}
                  </div>
                </div>

              </div>

              {/* å†å²è´¦å•å…¨å±å¼¹çª— */}
              {isHistoryOpen && (
                <div className="fixed inset-0 bg-white z-50 flex flex-col" style={{ backgroundColor: COLORS.bg }}>
                  <div className="flex justify-between items-center p-4 border-b-4 border-black bg-white shadow-sm" style={{ borderColor: COLORS.blue }}>
                    <h2 className="text-2xl font-black" style={{ color: COLORS.blue }}>ğŸ“œ å…¨éƒ¨å†å²è´¦å•</h2>
                    <button onClick={() => setIsHistoryOpen(false)} className="text-3xl font-black text-gray-500 active:scale-90 px-2">âœ•</button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-10">
                    {records.map(rec => (
                      <div key={rec.id} className="bg-white p-4 flex items-center justify-between border-2 shadow-sm"
                           style={{ borderColor: rec.amount > 0 ? COLORS.green : COLORS.orange, borderRadius: getRandomBlobShape() }}>
                        <div className="flex items-center gap-3 overflow-hidden">
                          <div>
                            <div className="font-bold text-lg truncate max-w-[200px]">{rec.text}</div>
                            <div className="text-gray-500 font-bold text-sm">{rec.date}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <div className="font-black text-2xl flex-shrink-0" style={{ color: rec.amount > 0 ? COLORS.green : COLORS.orange }}>
                            {rec.amount > 0 ? '+' : ''}{rec.amount}
                          </div>
                          <button onClick={() => confirmDelete(rec.id)} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-sm active:scale-90 transition hover:bg-red-100" style={{ color: COLORS.orange }}>
                            âœ–ï¸
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* è®°è´¦å¼¹çª— Modal */}
              {modal.isOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                  <div className="bg-white w-full max-w-sm rounded-3xl p-6 relative border-4 border-black max-h-[90vh] overflow-y-auto"
                       style={{ boxShadow: `8px 8px 0px ${modal.type === 'income' ? COLORS.green : COLORS.orange}` }}>
                    
                    <h2 className="text-2xl font-black mb-4 text-center" style={{ color: modal.type === 'income' ? COLORS.green : COLORS.orange }}>
                      {modal.type === 'income' ? 'ğŸ’¸ æ”¶é’±å•¦' : 'ğŸ›ï¸ èŠ±é’±å•¦'}
                    </h2>

                    <div className="mb-4">
                      <label className="block text-sm font-bold text-gray-700 mb-1">
                        {modal.type === 'income' ? 'åŠ é’±æ—¥æœŸï¼š' : 'èŠ±é’±æ—¥æœŸï¼š'}
                      </label>
                      <input 
                        type="date" 
                        value={draftDate}
                        onChange={(e) => setDraftDate(e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-black font-bold text-gray-700"
                      />
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-bold text-gray-700 mb-1">é‡‘é¢ (å…ƒ)ï¼š</label>
                      <input 
                        type="number" 
                        value={draftAmount}
                        onChange={(e) => setDraftAmount(e.target.value)}
                        placeholder="å¡«å…¥æ•°å­—..."
                        className="w-full p-3 text-2xl font-black border-4 border-black rounded-xl text-center focus:outline-none"
                        style={{ borderColor: COLORS.blue }}
                      />
                    </div>

                    <div className="mb-2">
                      <label className="block text-sm font-bold text-gray-700 mb-1">
                        {modal.type === 'income' ? 'æ˜¯è°ç»™çš„ï¼Ÿ(æ‰“å­—)' : 'ä¹°äº†ä»€ä¹ˆï¼Ÿ(æ‰“å­—)'}
                      </label>
                      <input 
                        type="text" 
                        value={draftText}
                        onChange={(e) => setDraftText(e.target.value)}
                        placeholder={modal.type === 'income' ? 'æ¯”å¦‚ï¼šå¦ˆå¦ˆ / å¤–å©†' : 'æ¯”å¦‚ï¼šè´´çº¸ / ç©å…·'}
                        className="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-black"
                      />
                    </div>

                    <div className="flex gap-3 mt-6">
                      <button 
                        onClick={closeModal}
                        className="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-2xl border-2 border-gray-300">
                        å–æ¶ˆ
                      </button>
                      <button 
                        onClick={handleSaveRecord}
                        className="flex-1 py-3 text-white font-black rounded-2xl border-4 border-black shadow-md transform active:translate-y-1"
                        style={{ backgroundColor: modal.type === 'income' ? COLORS.green : COLORS.orange }}>
                        è®°åˆ°è´¦æœ¬é‡Œï¼
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* åˆ é™¤ç¡®è®¤å¼¹çª— */}
              {deleteConfirm.isOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]">
                  <div className="bg-white w-full max-w-xs rounded-3xl p-6 relative border-4 border-black text-center"
                       style={{ boxShadow: `8px 8px 0px ${COLORS.orange}` }}>
                    <h2 className="text-xl font-black mb-4" style={{ color: COLORS.orange }}>è¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ</h2>
                    <p className="text-sm text-gray-500 mb-6">åˆ é™¤åï¼Œå°é‡‘åº“çš„é’±ä¼šè‡ªåŠ¨é€€å›æˆ–æ‰£é™¤å“¦ï¼</p>
                    <div className="flex gap-3">
                      <button onClick={() => setDeleteConfirm({ isOpen: false, recordId: null })} className="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-2xl border-2 border-gray-300">
                        å–æ¶ˆ
                      </button>
                      <button onClick={executeDelete} className="flex-1 py-3 text-white font-black rounded-2xl border-4 border-black shadow-md" style={{ backgroundColor: COLORS.orange }}>
                        ç¡®è®¤åˆ é™¤
                      </button>
                    </div>
                  </div>
                </div>
              )}

            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>